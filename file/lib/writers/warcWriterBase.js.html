<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">lib/writers/warcWriterBase.js | node-warc</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="A high fidelity, user scriptable, archival crawler that uses Chrome with/without a head."><meta property="twitter:card" content="summary"><meta property="twitter:title" content="node-warc"><meta property="twitter:description" content="A high fidelity, user scriptable, archival crawler that uses Chrome with/without a head."></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/N0taN3rd/node-warc"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#parsers">parsers</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/parsers/autoWARCParser.js~AutoWARCParser.html">AutoWARCParser</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/parsers/gzipDetector.js~GzipDetector.html">GzipDetector</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/parsers/warcGzParser.js~WARCGzParser.html">WARCGzParser</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/parsers/warcParser.js~WARCParser.html">WARCParser</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/parsers/warcStreamTransform.js~WARCStreamTransform.html">WARCStreamTransform</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-recordIterator">recordIterator</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#requestcapturers">requestCapturers</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/requestCapturers/capturedRequest.js~CapturedRequest.html">CapturedRequest</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/requestCapturers/cdpRequestInfo.js~CDPRequestInfo.html">CDPRequestInfo</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/requestCapturers/criExtra.js~CRIExtraRequestCapturer.html">CRIExtraRequestCapturer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/requestCapturers/electron.js~ElectronRequestCapturer.html">ElectronRequestCapturer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/requestCapturers/puppeteer.js~PuppeteerRequestCapturer.html">PuppeteerRequestCapturer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/requestCapturers/puppeteerCDP.js~PuppeteerCDPRequestCapturer.html">PuppeteerCDPRequestCapturer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/requestCapturers/remoteChrome.js~RemoteChromeRequestCapturer.html">RemoteChromeRequestCapturer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/requestCapturers/requestHandler.js~RequestHandler.html">RequestHandler</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-CDPRequestInfo">CDPRequestInfo</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-CRIExtraCapturer">CRIExtraCapturer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-CapturedRequest">CapturedRequest</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ElectronCapturer">ElectronCapturer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-PuppeteerCDPCapturer">PuppeteerCDPCapturer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-PuppeteerCapturer">PuppeteerCapturer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-RemoteChromeCapturer">RemoteChromeCapturer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-RequestHandler">RequestHandler</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#utils">utils</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/utils/electronGetResError.js~ElectronGetResError.html">ElectronGetResError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ensureWARCFilename">ensureWARCFilename</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getResBodyElectron">getResBodyElectron</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-stringifyHeaders">stringifyHeaders</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-stringifyRequestHeaders">stringifyRequestHeaders</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isEmptyPlainObject">isEmptyPlainObject</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ElectronGetResError">ElectronGetResError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-constants">constants</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ensureWARCFilename">ensureWARCFilename</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-getResBodyElectron">getResBodyElectron</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-isEmptyPlainObject">isEmptyPlainObject</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-stringifyHeaders">stringifyHeaders</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-stringifyRequestHeaders">stringifyRequestHeaders</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#warcrecord">warcRecord</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/warcRecord/builder.js~RecordBuilder.html">RecordBuilder</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/warcRecord/record.js~WARCRecord.html">WARCRecord</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/warcRecord/warcContentParsers.js~ContentParser.html">ContentParser</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ContentParser">ContentParser</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-RecordBuilder">RecordBuilder</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-WARCRecord">WARCRecord</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-RequestHTTP">RequestHTTP</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-ResponseHTTP">ResponseHTTP</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#writers">writers</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/writers/criExtra.js~CRIExtraWARCGenerator.html">CRIExtraWARCGenerator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/writers/electron.js~ElectronWARCGenerator.html">ElectronWARCGenerator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/writers/puppeteer.js~PuppeteerWARCGenerator.html">PuppeteerWARCGenerator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/writers/puppeteerCDP.js~PuppeteerCDPWARCGenerator.html">PuppeteerCDPWARCGenerator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/writers/remoteChrome.js~RemoteChromeWARCGenerator.html">RemoteChromeWARCGenerator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/writers/requestLib.js~RequestLibWARCGenerator.html">RequestLibWARCGenerator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/writers/warcWriterBase.js~WARCWriterBase.html">WARCWriterBase</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-CRIExtraWARCGenerator">CRIExtraWARCGenerator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ElectronWARCWriter">ElectronWARCWriter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-PuppeteerCDPWARCGenerator">PuppeteerCDPWARCGenerator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-PuppeteerWARCGenerator">PuppeteerWARCGenerator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-RemoteChromeWARCWriter">RemoteChromeWARCWriter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-WARCWriterBase">WARCWriterBase</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-WARCInfoHeader">WARCInfoHeader</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-WARCMetadataHeader">WARCMetadataHeader</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-WARCRequestHeader">WARCRequestHeader</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-WARCResponseHeader">WARCResponseHeader</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-Metadata">Metadata</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-WARCFileOpts">WARCFileOpts</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-WARCGenOpts">WARCGenOpts</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-WARCInitOpts">WARCInitOpts</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">lib/writers/warcWriterBase.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">const fs = require(&apos;fs-extra&apos;)
const zlib = require(&apos;zlib&apos;)
const Path = require(&apos;path&apos;)
const uuid = require(&apos;uuid/v1&apos;)
const EventEmitter = require(&apos;eventemitter3&apos;)
const {
  warcInfoHeader,
  warcInfoContent,
  warcRequestHeader,
  warcResponseHeader,
  warcMetadataHeader,
  recordSeparator,
  CRLF,
  CRLF2x
} = require(&apos;./warcFields&apos;)
const ensureWARCFileName = require(&apos;../utils/ensureWARCFilename&apos;)

/**
 * @type {Buffer}
 */
const recordSeparatorBuffer = Buffer.from(recordSeparator, &apos;utf8&apos;)

/**
 * @type {Buffer}
 */
const CRLFBuffer = Buffer.from(CRLF, &apos;utf8&apos;)

/**
 * @type {number}
 */
const WARCSepTSize = recordSeparatorBuffer.length + CRLFBuffer.length

/**
 *
 * @param {string} string
 * @param {?Buffer|?string} maybeBuffer
 * @return {Buffer}
 */
function makeContentBuffer (string, maybeBuffer) {
  if (maybeBuffer != null) {
    // ensure that the string buffer contains CRLF 2x since we have a body
    const strBuff = string.endsWith(CRLF2x)
      ? Buffer.from(string, &apos;utf8&apos;)
      : Buffer.from(`${string}${CRLF}`, &apos;utf8&apos;)
    const cntBuffer = Buffer.isBuffer(maybeBuffer)
      ? maybeBuffer
      : Buffer.from(maybeBuffer, &apos;utf8&apos;)
    return Buffer.concat(
      [strBuff, cntBuffer],
      strBuff.length + cntBuffer.length
    )
  }
  return Buffer.from(string, &apos;utf8&apos;)
}

/**
 * @desc Default options that control how WARC writting is done
 * @param {WARCFileOpts} [opts]
 * @return {WARCFileOpts}
 */
function ensureOptions (opts) {
  if (opts == null) {
    opts = {}
  }
  return {
    appending: opts.appending || false,
    gzip: opts.gzip || process.env.NODEWARC_WRITE_GZIPPED != null
  }
}

/**
 * @extends {EventEmitter}
 * @desc Base class used for writing to the WARC
 */
class WARCWriterBase extends EventEmitter {
  /**
   * @desc Create a new WARCWriter
   * @param {?WARCFileOpts} [defaultOpts] - Optional default WARC file options
   */
  constructor (defaultOpts) {
    super()
    /**
     * @type {?WriteStream}
     * @private
     */
    this._warcOutStream = null
    /**
     * @type {?Error}
     * @private
     */
    this._lastError = null
    /**
     * @type {?string}
     * @private
     */
    this._now = null
    /**
     * @type {?string}
     * @private
     */
    this._fileName = null
    /**
     * @type {?string}
     * @private
     */
    this._warcInfoId = null

    /**
     * @type {?WARCFileOpts}
     */
    this.opts = null

    /**
     * @type {WARCFileOpts}
     */
    this.defaultOpts = ensureOptions(defaultOpts)

    /**
     * @type {string}
     * @private
     */
    this._version = require(&apos;../../package.json&apos;).version
    this._onFinish = this._onFinish.bind(this)
    this._onError = this._onError.bind(this)
  }

  /**
   * @desc Set the default WARC creation options
   * @param {WARCFileOpts} defaultOpts - The new default options
   */
  setDefaultOpts (defaultOpts) {
    this.defaultOpts = ensureOptions(defaultOpts)
  }

  /**
   * @desc Initialize the writer. The options object is optional and defaults to `appending = false` and `gzip = process.env.NODEWARC_WRITE_GZIPPED != null`.
   * Writing gzipped records is also controllable by setting `NODEWARC_WRITE_GZIPPED` environment variable.
   * Options supplied to this method override the default options.
   * @param {string} warcPath - the path for the WARC file to be written
   * @param {?WARCFileOpts} [options] - write options controlling how the WARC should be written
   */
  initWARC (warcPath, options) {
    this.opts = Object.assign({}, this.defaultOpts, options || {})
    const wfp = ensureWARCFileName(warcPath, this.opts.gzip)
    if (this.opts.appending) {
      this._warcOutStream = fs.createWriteStream(wfp, {
        flags: &apos;a&apos;,
        encoding: &apos;utf8&apos;
      })
    } else {
      this._warcOutStream = fs.createWriteStream(wfp, { encoding: &apos;utf8&apos; })
    }
    this._warcOutStream.on(&apos;finish&apos;, this._onFinish)
    this._warcOutStream.on(&apos;error&apos;, this._onError)
    let now = new Date().toISOString()
    this._now = now.substr(0, now.indexOf(&apos;.&apos;)) + &apos;Z&apos;
    this._fileName = Path.basename(wfp)
  }

  /**
   * @param {string} targetURI - The target URI for the request response record pairs
   * @param {{headers: string, data?: Buffer|string}} reqData - The request data
   * @param {{headers: string, data?: Buffer|string}} resData - The response data
   * @return {Promise&lt;void&gt;}
   */
  async writeRequestResponseRecords (targetURI, reqData, resData) {
    const resRecId = uuid()
    await this._writeRequestRecord(
      targetURI,
      resRecId,
      reqData.headers,
      reqData.data
    )
    return this._writeResponseRecord(
      targetURI,
      resRecId,
      resData.headers,
      resData.data
    )
  }

  /**
   * @desc Write arbitrary number of items to the WARC
   * @param {Buffer[]} recordParts - Array of buffers to be writtern
   * @return {Promise&lt;void&gt;}
   */
  async writeRecordChunks (...recordParts) {
    for (let chunk of recordParts) {
      await this.writeRecordBlock(chunk)
    }
  }

  /**
   * @desc Write out the WARC-Type: info records.
   * If the contents for the info record is an object then the objects properties (property, property value pairs)
   * are written otherwise (when Buffer or string) the content is written as is
   * @param {Object|Buffer|string} winfo - The contents for the WARC info record
   * @return {Promise&lt;void&gt;}
   */
  writeWarcInfoRecord (winfo) {
    if (Buffer.isBuffer(winfo) || typeof winfo === &apos;string&apos;) {
      return this.writeWarcRawInfoRecord(winfo)
    }
    if (winfo.software == null) {
      winfo.software = `node-warc/${this._version}`
    }
    return this.writeWarcRawInfoRecord(
      Buffer.from(warcInfoContent(winfo), &apos;utf8&apos;)
    )
  }

  /**
   * @desc Write warc-info record
   * @param {string|Buffer} warcInfoContent - The contents of the warc-info record
   * @return {Promise&lt;void&gt;}
   */
  writeWarcRawInfoRecord (warcInfoContent) {
    let recID
    if (this._warcInfoId) {
      recID = uuid()
    } else {
      this._warcInfoId = recID = uuid()
    }
    const whct = Buffer.isBuffer(warcInfoContent)
      ? warcInfoContent
      : Buffer.from(warcInfoContent, &apos;utf8&apos;)
    const wh = Buffer.from(
      warcInfoHeader({
        date: this._now,
        fileName: this._fileName,
        len: whct.length,
        rid: recID
      }),
      &apos;utf8&apos;
    )
    const totalLength = wh.length + whct.length + WARCSepTSize
    return this.writeRecordBlock(
      Buffer.concat([wh, CRLFBuffer, whct, recordSeparatorBuffer], totalLength)
    )
  }

  /**
   * @desc Writes a WARC Info record containing Webrecorder/Webrecorder Player bookmark (page list)
   * @param {string|Array&lt;string&gt;} pages - The URL of the page this WARC contains or an Array of URLs for the pages
   * this WARC contains
   * @return {Promise&lt;void&gt;}
   */
  writeWebrecorderBookmarksInfoRecord (pages) {
    let recID
    if (this._warcInfoId) {
      recID = uuid()
    } else {
      this._warcInfoId = recID = uuid()
    }
    const winfoContent = {
      software: `node-warc/${this._version}`,
      &apos;json-metadata&apos;: JSON.stringify({
        desc: &apos;&apos;,
        auto_title: true,
        type: &apos;recording&apos;,
        pages: Array.isArray(pages)
          ? pages.map(page =&gt; ({ timestamp: this._now, url: page }))
          : [{ timestamp: this._now, url: pages }]
      })
    }
    const whct = Buffer.from(warcInfoContent(winfoContent), &apos;utf8&apos;)
    const wh = Buffer.from(
      warcInfoHeader({
        date: this._now,
        fileName: this._fileName,
        len: whct.length,
        rid: recID
      }),
      &apos;utf8&apos;
    )
    const totalLength = wh.length + whct.length + WARCSepTSize
    return this.writeRecordBlock(
      Buffer.concat([wh, CRLFBuffer, whct, recordSeparatorBuffer], totalLength)
    )
  }

  /**
   * @desc Write WARC-Type: metadata for outlinks
   * @param {string} targetURI - The target URI for the metadata record
   * @param {string} outlinks - A string containing outlink metadata
   * @return {Promise&lt;void&gt;}
   */
  writeWarcMetadataOutlinks (targetURI, outlinks) {
    return this.writeWarcMetadata(targetURI, outlinks)
  }

  /**
   * @desc Write WARC-Type: metadata record
   * @param {string} targetURI - The URL of the page the this metadata record is for
   * @param {string|Buffer} metaData - A string or buffer containing metadata information to be used as this records content
   * @return {Promise&lt;void&gt;}
   */
  writeWarcMetadata (targetURI, metaData) {
    const wmhc = Buffer.isBuffer(metaData)
      ? metaData
      : Buffer.from(metaData, &apos;utf8&apos;)
    const wmh = Buffer.from(
      warcMetadataHeader({
        targetURI,
        now: this._now,
        len: wmhc.length,
        concurrentTo: this._warcInfoId,
        rid: uuid()
      }),
      &apos;utf8&apos;
    )
    const totalLength = wmhc.length + wmh.length + WARCSepTSize
    return this.writeRecordBlock(
      Buffer.concat([wmh, CRLFBuffer, wmhc, recordSeparatorBuffer], totalLength)
    )
  }

  /**
   * @desc Write A Request Record
   * @param {string} targetURI - The URL of the response
   * @param {string} httpHeaderString - Stringified HTTP headers
   * @param {string|Buffer} [requestData] - Body of the request if any
   * @return {Promise&lt;void&gt;}
   */
  writeRequestRecord (targetURI, httpHeaderString, requestData) {
    return this._writeRequestRecord(
      targetURI,
      null,
      httpHeaderString,
      requestData
    )
  }

  /**
   * @desc Write A Response Record
   * @param {string} targetURI - The URL of the response
   * @param {string} httpHeaderString - Stringified HTTP headers
   * @param {string|Buffer} [responseData] - The response body if it exists
   * @return {Promise&lt;void&gt;}
   */
  writeResponseRecord (targetURI, httpHeaderString, responseData) {
    return this._writeResponseRecord(
      targetURI,
      uuid(),
      httpHeaderString,
      responseData
    )
  }

  /**
   * @desc Write an record block to the WARC
   * @param {Buffer} recordBuffer
   * @return {Promise&lt;void&gt;}
   */
  writeRecordBlock (recordBuffer) {
    return new Promise((resolve, reject) =&gt; {
      if (this.opts.gzip) {
        // we&apos;re in gzipped mode - GZip the buffer
        recordBuffer = zlib.gzipSync(recordBuffer)
      }

      if (!this._warcOutStream.write(recordBuffer, &apos;utf8&apos;)) {
        this._warcOutStream.once(&apos;drain&apos;, resolve)
      } else {
        resolve()
      }
    })
  }

  /**
   * @desc Close  the underlying filestream to the WARC currently being written.
   * The `finished` event will not be emitted until this method has been called
   */
  end () {
    if (this._warcOutStream != null) {
      this._warcOutStream.end()
    }
  }

  /**
   * @desc Write A Request Record
   * @param {string} targetURI - The URL of the response
   * @param {?string} resId - The id of the record this request recorrd is concurrent to, typically its response
   * @param {string} httpHeaderString - Stringified HTTP headers
   * @param {string|Buffer} [requestData] - Body of the request if any
   * @return {Promise&lt;void&gt;}
   */
  _writeRequestRecord (targetURI, resId, httpHeaderString, requestData) {
    const reqHeadContentBuffer = makeContentBuffer(
      httpHeaderString,
      requestData
    )
    const reqWHeader = Buffer.from(
      warcRequestHeader({
        targetURI,
        concurrentTo: resId,
        now: this._now,
        rid: uuid(),
        wid: this._warcInfoId,
        len: reqHeadContentBuffer.length
      }),
      &apos;utf8&apos;
    )
    const totalLength =
      reqWHeader.length + reqHeadContentBuffer.length + WARCSepTSize
    return this.writeRecordBlock(
      Buffer.concat(
        [reqWHeader, CRLFBuffer, reqHeadContentBuffer, recordSeparatorBuffer],
        totalLength
      )
    )
  }

  /**
   * @desc Write A Response Record
   * @param {string} targetURI - The URL of the response
   * @param {string} resId - The id to be used for the response record
   * @param {string} httpHeaderString - Stringified HTTP headers
   * @param {string|Buffer} [responseData] - The response body if it exists
   * @return {Promise&lt;void&gt;}
   */
  _writeResponseRecord (targetURI, resId, httpHeaderString, responseData) {
    const resHeaderContentBuffer = makeContentBuffer(
      httpHeaderString,
      responseData
    )
    const respWHeader = Buffer.from(
      warcResponseHeader({
        targetURI,
        now: this._now,
        rid: resId,
        wid: this._warcInfoId,
        len: resHeaderContentBuffer.length
      }),
      &apos;utf8&apos;
    )
    const totalLength =
      respWHeader.length + resHeaderContentBuffer.length + WARCSepTSize
    return this.writeRecordBlock(
      Buffer.concat(
        [
          respWHeader,
          CRLFBuffer,
          resHeaderContentBuffer,
          recordSeparatorBuffer
        ],
        totalLength
      )
    )
  }

  /**
   * @desc Called when the WARC generation is finished
   * @emits {finished} emitted when WARC generation is complete
   * @private
   */
  _onFinish () {
    let le = this._lastError
    this._lastError = null
    this._warcOutStream.removeAllListeners()
    this._warcOutStream.destroy()
    this._warcOutStream = null
    this._now = null
    this._fileName = null
    this._warcInfoId = null
    if (le) {
      this.emit(&apos;finished&apos;, le)
    } else {
      this.emit(&apos;finished&apos;)
    }
  }

  /**
   * @desc Emits an error if one occurs
   * @param {Error} err
   * @emits {error} The error that occurred
   * @private
   */
  _onError (err) {
    this._lastError = err
    this.emit(&apos;error&apos;, err)
  }
}

/**
 * @type {WARCWriterBase}
 */
module.exports = WARCWriterBase

/**
 * @typedef {Object} WARCFileOpts
 * @property {boolean} [appending] - Should the WARC writer append to an existing warc?
 * @property {boolean} [gzip] - Should the WARC writer generate gziped records?
 */

/**
 * @typedef {Object} WARCInitOpts
 * @property {string} warcPath - Path the warc file to be written to
 * @property {boolean} [appending] - Should the WARC writer append to an existing warc?
 * @property {boolean} [gzip] - Should the WARC writer generate gziped records?
 */

/**
 * @typedef {Object} Metadata
 * @property {string} targetURI - The target URI for the metadata record
 * @property {?string|Buffer} [content] - The contents of the metadata record
 */

/**
 * @typedef {Object} WARCGenOpts
 * @property {string|Array&lt;string&gt;} pages - The URL of the page this WARC contains or an Array of
 * URLs for the pages this WARC contains. Used to write a WARC Info record containing
 * Webrecorder Player compatible bookmark list
 * @property {WARCInitOpts} warcOpts - Options for the writing of the WARC file
 * @property {Object|Buffer|string} [winfo] - Optional contents for the WARC info record
 * @property {Metadata} [metadata] - Optional metadata contents
 */
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
